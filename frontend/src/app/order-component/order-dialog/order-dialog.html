<h2 mat-dialog-title>
  <mat-icon>add_business</mat-icon>
  {{ 'Add New Order' }}
</h2>

<mat-dialog-content [formGroup]="orderForm">
  <!-- Customer Selection -->
  <div class="form-row">
    <mat-form-field appearance="fill" class="custom-width">
      <mat-label>Select Customer</mat-label>
      <mat-select formControlName="customerId" required>
        <mat-option *ngFor="let customer of customers" [value]="customer.customerId">
          {{ customer.name }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="orderForm.get('customerId')?.hasError('required')">
        Customer is required.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Agent Selection -->
  <div class="form-row">
    <mat-form-field appearance="fill" class="custom-width">
      <mat-label>Select Agent</mat-label>
      <mat-select formControlName="agentId" required>
        <mat-option *ngFor="let agent of agents" [value]="agent.id">
          {{ agent.fullName }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="orderForm.get('agentId')?.hasError('required')">
        Agent is required.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Products List with Quantity Inputs -->
  <div class="form-group">
    <label class="form-label">Products</label>

    <div *ngIf="products.length > 0; else noProductsBlock">
      <div *ngFor="let product of products; let i = index" class="product-row">
        <div class="product-info">
          <span class="product-name">{{ product.name }}</span>
          <span class="product-stock">Available: {{ product.stockQuantity }}</span>
        </div>

        <mat-form-field appearance="outline" class="quantity-field">
          <input matInput type="number" [formControl]="getQuantityControl(i)" placeholder="Quantity" min="0"
            [max]="product.stockQuantity">

          <mat-error *ngIf="getQuantityControl(i).hasError('min')">
            Quantity must be at least 0.
          </mat-error>
          <mat-error *ngIf="getQuantityControl(i).hasError('max')">
            Cannot exceed available stock.
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- If no products -->
    <ng-template #noProductsBlock>
      <mat-error>No products available to order.</mat-error>
    </ng-template>
  </div>

  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()">Cancel</button>
    <button mat-raised-button color="primary" (click)="onSave()" [disabled]="!orderForm.valid">
      <mat-icon>add</mat-icon>
      Add Order
    </button>
  </mat-dialog-actions>